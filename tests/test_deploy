#!/usr/bin/env bash
set -eo pipefail
SELF=`which $0`; APP="$1"; TARGET="$2"; FORWARDED_PORT="$3"
TMP=$(mktemp -d -t "$TARGET.XXXXX")
trap "rm -rf $TMP" EXIT
rmdir $TMP && cp -r $(dirname $SELF)/$APP $TMP
cd $TMP
git init
git config user.email "robot@example.com"
git config user.name "Test Robot"
git add .
git commit -m 'initial commit'
REPO="test-$(basename $APP)-$RANDOM"
git remote add target dokku@$TARGET:$REPO
git push target master
# Disable Pseudo-TTY allocation or else $FORWARDED_PORT cannot be appended to
# the url correctly.
# e.g. (with RequestTTY): :8080//test-nodejs-express-10694.dokku.me
#      (disable PTY): http://test-nodejs-express-10694.dokku.me:8080
URL="$(ssh -T dokku@$TARGET url $REPO)$FORWARDED_PORT"
sleep 2
./check_deploy $URL && echo "-----> Deploy success!" || {
  sleep 4
  ./check_deploy $URL && echo "-----> Deploy success!"
}
